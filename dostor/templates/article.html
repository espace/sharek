{% extends 'base.html' %}

{% load replace %}
{% load hash %} 
{% block title %}{{article.name}}{% endblock %}

{% block content %}

<div class="row">
    <div class="span12 ">
        <h1 class="headtitle">{{tag.name}}</h1>
    </div>
</div><!-- row -end -->
<div class="row">

    <div class="span4">
        {% include "sidebar.html" %}
    </div><!-- span3 -->

    <div id="ajax-container" class="span8">
        
            <div class="topic">
                <h3><p class="mada-title"><a>{{article.name}}</a> <a href="#" class="comments-number pull-left"><i style="margin-top:4px; margin-left:5px;" class="icon-comment icon-white"></i>{{feedbacks.count}} تعليق</a></p></h3>  
                <p>{{article.summary}}</p>
            </div><!-- topic end -->
    
            <span class="divider"></span>
            {% if user %}
            <div class="comment-block comment-entry">
                <div class="form-horizontal">
                    <fieldset>
                        <legend>أضف تعليق </legend>
                         <div class="control-group">
                              <label for="textarea" class="control-label">التعليق</label>
                              <div class="controls">
                                <textarea id="suggestion" class="input-xlarge" id="textarea" rows="3" name="suggestion"></textarea>
                              </div>
                         </div>
                         <div class="form-actions">
                              <button class="btn btn-inverse" id="modify">أضف الآن !</button>
                         </div>
                    </fieldset> 
                </div>
            </div><!-- comment end -->
            {% endif %}

            {% for feedback in feedbacks %}
            <div class="comment-block ">
    
                <h3><p class="name"><a href="#">{{feedback.name}}</a></p></h3> 
                <img src="http://graph.facebook.com/{{ feedback.user }}/picture" class="loader"/>
                <div class="like-group">
                   <i class="icon-thumbs-up"></i><a href="#" class="like vote {{feedback.id}}" id="{{feedback.id}}" vote="1">{{p_votes|key:feedback.id }}</a>
                   <i class="icon-thumbs-down"></i><a href="#" class="dislike vote {{feedback.id}}" id="{{feedback.id}}" vote="0">{{n_votes|key:feedback.id }} </a>
                </div>
                <p>{{feedback.suggestion}}</p>
                <span class="date">{{feedback.date}}</span>
    
            </div><!-- comment end -->
            {% endfor %}

            <script type="text/javascript">
              $(document).ready(function() {

               $(".vote").live("click",function(){
                $.ajax({
                        type:"POST",
                        url :"/vote/",
                        data:{'article':{{article.id}},'modification': this.id ,'type': $(this).attr('vote') ,'csrfmiddlewaretoken': $("{% csrf_token %}").find("input").attr("value")},
                        dataType:"json",
                        error:function(data){},
                        success:function(data){
                        $(".like"+"."+data.modification).text(data.p);  
                        $(".dislike"+"."+data.modification).text(data.n);  
                        },
                      });
                    });

                $("#modify").click(function(){
                  $.ajax({
                        type:"POST",
                        url :"/modify/",
                        data:{
                            'link': document.URL,
                            'user_id':"{{user}}",
                            'name':"{{user.first_name}} {{ user.last_name }}",
                            'article':"{{article.id}}",
                            'email': "{{user.email}}",
                            'csrfmiddlewaretoken': $("{% csrf_token %}").find("input").attr("value"),
                            'suggestion': $("#suggestion").val()},
                        dataType:"json",
                        error:function(data){},
                        success:function(data){
                        $("#suggestion").val("");
                        $(".comment-block.comment-entry").after($("#modification_temp").tmpl({"id":data.id ,"date": "Just now", "suggestion": data.suggestion}));
                        },
                    });
                });
              });
            </script>


            <script id="modification_temp" type="text/x-jquery-tmpl">
              <div class="comment-block ">
                <h3><p class="name"><a href="#">{{user.first_name}} {{ user.last_name }}</a></p></h3> 
                <img src="http://graph.facebook.com/{{ user }}/picture" class="loader"/>
                <div class="like-group">
                   <i class="icon-thumbs-up"></i><a href="#" class="like vote ${id}" id="${id}" vote="1">0</a>
                   <i class="icon-thumbs-down"></i><a href="#" class="dislike vote ${id}" id="${id}" vote="0">0</a>
                </div>
                <p>${suggestion}</p>
                <span class="date">${date}</span>
              </div><!-- comment end -->
            </script>

    </div><!-- span 8 -->

</div><!-- row end -->
  
{% endblock %}